suite: Deployment configuration
templates:
  - deployment.yaml
set:
  hub:
    token: "xxx"
tests:
  - it: should set minimal required parameters when enabling Traefik Hub API Gateway
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: HUB_TOKEN
            valueFrom:
              secretKeyRef:
                key: token
                name: xxx
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.token=$(HUB_TOKEN)"
  - it: should set minimal required parameters when enabling Traefik Hub API Management
    set:
      hub:
        apimanagement:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: HUB_TOKEN
            valueFrom:
              secretKeyRef:
                key: token
                name: xxx
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.listenAddr=:9943"
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: "admission"
            containerPort: 9943
            protocol: "TCP"
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: "apiportal"
            containerPort: 9903
            protocol: "TCP"
  - it: should fail when trying to set admission parameters without apimanagement
    set:
      hub:
        apimanagement:
          admission:
            listenAddr: "10.0.0.1:7500"
            secretName: "secret"
    asserts:
      - failedTemplate:
          errorMessage: "ERROR: Cannot configure admission without enabling hub.apimanagement"
  - it: should be possible to set admission parameters (and ignore extra)
    set:
      hub:
        apimanagement:
          enabled: true
          admission:
            listenAddr: "10.0.0.1:7500"
            secretName: "secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.listenAddr=10.0.0.1:7500"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.secretName=secret"
  - it: api management should not be enabled by default
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement"
  - it: should be possible to enable and configure opentelemetry parameters (and ignore extra)
    set:
      hub:
        metrics:
          opentelemetry:
            enabled: true
            address: "address"
            explicitBoundaries: "0.1,0.3,1.2,5.0"
            grpc: true
            headers:
              foo: bar
              foo2: bar2
            insecure: true
            path: "path"
            pushInterval: "2m"
            tls:
              ca: "ca"
              cert: "cert"
              insecureSkipVerify: true
              key: "key"
            test: "dontexist"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.address=address"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.explicitBoundaries=0.1,0.3,1.2,5.0"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.grpc=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.headers.foo=bar"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.headers.foo2=bar2"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.path=path"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.pushInterval=2m"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.tls.cert=cert"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.tls.ca=ca"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.tls.insecureSkipVerify=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.tls.key=key"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.metrics.opentelemetry.test=test"
  - it: should be possible to specify platformUrl
    set:
      hub:
        platformUrl: "fooUrl"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.platformUrl=fooUrl"
  - it: should be possible to specify ratelimit parameters (and ignore extra)
    set:
      hub:
        ratelimit:
          redis:
            cluster: true
            database: "database"
            endpoints: "localhost:7000"
            username: "user"
            password: "pass"
            sentinel:
              masterset: "master"
              username: "usern"
              password: "passw"
            timeout: "30s"
            tls:
              ca: "ca"
              cert: "cert"
              insecureSkipVerify: true
              key: "key"
            test: "test"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.cluster=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.database=database"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.endpoints=localhost:7000"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.username=user"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.password=pass"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.sentinel.masterset=master"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.sentinel.username=usern"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.sentinel.password=passw"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.timeout=30s"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.tls.ca=ca"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.tls.cert=cert"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.tls.insecureSkipVerify=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.tls.key=key"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.ratelimit.redis.test=test"
  - it: should be possible to specify sendlogs
    set:
      hub:
        sendlogs: "sendlogs"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.sendlogs=sendlogs"
