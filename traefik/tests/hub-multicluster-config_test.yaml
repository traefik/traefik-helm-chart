suite: Traefik configuration
templates:
  - deployment.yaml
tests:
  - it: should be possible to configure Traefik Hub multicluster provider
    set:
      hub:
        token: "xxx"
        providers:
          multicluster:
            enabled: true
            children:
              child1:
                address: http://foo
              child2:
                address: http://bar
                serversTransport:
                  insecureSkipVerify: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster.children.child1.address=http://foo"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster.children.child2.serversTransport.insecureSkipVerify=true"

  - it: should be possible to configure Traefik Hub multicluster provider serversTransport certificates
    set:
      hub:
        token: "xxx"
        providers:
          multicluster:
            enabled: true
            children:
              child1:
                address: http://foo
              child2:
                address: http://bar
                serversTransport:
                  rootCAs:
                    - /certs/ca.crt
                    - /certs/ca2.crt
                  certificates:
                    - certFile: /certs/client.crt
                      keyFile: /certs/client.key
                    - certFile: /certs/client2.crt
                      keyFile: /certs/client2.key
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster.children.child1.address=http://foo"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster.children.child2.serversTransport.rootCAs=/certs/ca.crt,/certs/ca2.crt"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster.children.child2.serversTransport.certificates[0].certFile=/certs/client.crt"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster.children.child2.serversTransport.certificates[0].keyFile=/certs/client.key"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster.children.child2.serversTransport.certificates[1].certFile=/certs/client2.crt"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.multicluster.children.child2.serversTransport.certificates[1].keyFile=/certs/client2.key"

  - it: should be possible to configure Traefik Hub uplinkEntryPoints
    set:
      ports:
        web: null
        websecure: null
        metrics: null
        multicluster:
          port: 9443
          asDefault: true
          uplink: true
          expose:
            default: true
          http:
            tls:
              enabled: true
      hub:
        token: "xxx"
        providers:
          multicluster:
            enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.uplinkEntryPoints.multicluster.address=:9443/tcp"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.uplinkEntryPoints.multicluster.asDefault=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.uplinkEntryPoints.multicluster.http.tls=true"

  - it: should fail on typo when configuring Traefik Hub multicluster provider
    set:
      hub:
        token: "xxx"
        providers:
          multicluster:
            enabled: true
            children:
              child1:
                adress: http://foo # <=== typo here
              child2:
                address: http://bar
    asserts:
      - failedTemplate:
          errorPattern: "values don't meet the specifications of the schema"

  - it: should fail on typo when configuring Traefik Hub uplink entrypoint
    set:
      hub:
        token: "xxx"
        providers:
          multicluster:
            enabled: true
        uplinkEntryPoints:
          multicluster:
            address: ":9443"
    asserts:
      - failedTemplate:
          errorPattern: "values don't meet the specifications of the schema"
