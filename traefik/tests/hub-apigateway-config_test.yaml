suite: Traefik Hub API Gateway configuration
templates:
  - deployment.yaml
set:
  hub:
    token: "xxx"
tests:
  - it: should set minimal required parameters when enabling Traefik Hub API Gateway
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: HUB_TOKEN
            valueFrom:
              secretKeyRef:
                key: token
                name: xxx
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.token=$(HUB_TOKEN)"
  - it: should set the offline flag when offline is enabled
    set:
      hub:
        offline: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.offline=true"
  - it: should set the offline flag when offline is disabled
    set:
      hub:
        offline: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.offline=false"
  - it: should set minimal required parameters when enabling Traefik Hub API Management
    set:
      hub:
        apimanagement:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: HUB_TOKEN
            valueFrom:
              secretKeyRef:
                key: token
                name: xxx
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.listenAddr=:9943"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.offline=false"
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: admission
            containerPort: 9943
            protocol: TCP
  - it: should not expose admission port when offline mode is enabled
    set:
      hub:
        offline: true
        apimanagement:
          enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.listenAddr=:9943"
      - notContains:
          path: spec.template.spec.containers[0].ports
          content:
            name: admission
            containerPort: 9943
            protocol: TCP
  - it: should fail when trying to set admission parameters without apimanagement
    set:
      hub:
        apimanagement:
          admission:
            listenAddr: "10.0.0.1:7500"
            secretName: "secret"
    asserts:
      - failedTemplate:
          errorMessage: "ERROR: Cannot configure admission without enabling hub.apimanagement"
  - it: should be possible to set admission parameters (and ignore extra)
    set:
      hub:
        apimanagement:
          enabled: true
          admission:
            listenAddr: "10.0.0.1:7500"
            secretName: "secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.listenAddr=10.0.0.1:7500"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.secretName=secret"
  - it: should not set admission parameters when offline mode is enabled
    set:
      hub:
        offline: true
        apimanagement:
          enabled: true
          admission:
            listenAddr: "10.0.0.1:7500"
            secretName: "secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.listenAddr=10.0.0.1:7500"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement.admission.secretName=secret"
      - notContains:
          path: spec.template.spec.containers[0].ports
          content:
            name: admission
            containerPort: 7500
            protocol: TCP
  - it: should be possible to enforce OAS
    set:
      hub:
        apimanagement:
          enabled: true
          openApi:
            validateRequestMethodAndPath: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apiManagement.openApi.validateRequestMethodAndPath=true"
  - it: api management and ai gateway should not be enabled by default
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.apimanagement"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.aigateway"
  - it: should be possible to specify platformUrl
    set:
      hub:
        platformUrl: "fooUrl"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.platformUrl=fooUrl"
  - it: should not set platformUrl when offline mode is enabled
    set:
      hub:
        offline: true
        platformUrl: "fooUrl"
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.platformUrl=fooUrl"
  - it: should be possible to specify ratelimit parameters (and ignore extra)
    set:
      hub:
        redis:
          cluster: true
          database: "database"
          endpoints: "localhost:7000"
          username: "user"
          password: "pass"
          sentinel:
            masterset: "master"
            username: "usern"
            password: "passw"
          timeout: "30s"
          tls:
            ca: "ca"
            cert: "cert"
            insecureSkipVerify: true
            key: "key"
          test: "test"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.cluster=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.database=database"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.endpoints=localhost:7000"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.username=user"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.password=pass"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.sentinel.masterset=master"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.sentinel.username=usern"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.sentinel.password=passw"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.timeout=30s"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.tls.ca=ca"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.tls.cert=cert"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.tls.insecureSkipVerify=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.tls.key=key"
      - notContains:
          path: spec.template.spec.containers[0].args
          content: "--hub.redis.test=test"
  - it: should be possible to specify sendlogs
    set:
      hub:
        sendlogs: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.sendlogs=true"
  - it: should be possible to disable sendlogs
    set:
      hub:
        sendlogs: false
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.sendlogs=false"

  - it: should be possible to specify namespaces to watch
    set:
      hub:
        namespaces: [one, two, one]
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.namespaces=NAMESPACE,one,two"

  - it: should restart pods on certificate change by default
    set:
      hub:
        apimanagement:
          enabled: true
    asserts:
      - exists:
          path: spec.template.metadata.labels.hub-cert-hash

  - it: should be possible to disable pod restart on certificate change
    set:
      hub:
        apimanagement:
          enabled: true
          admission:
            restartOnCertificateChange: false
    asserts:
      - notExists:
          path: spec.template.metadata.labels.hub-cert-hash

  - it: should be possible to configure Traefik Hub additionalTraceHeaders
    set:
      tracing:
        otlp:
          enabled: true
      hub:
        tracing:
          additionalTraceHeaders:
            enabled: true
            traceContext:
              parentId: "parentId"
              traceId: "traceId"
              traceParent: "traceParent"
              traceState: "traceState"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.tracing.additionalTraceHeaders.traceContext.parentId=parentId"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.tracing.additionalTraceHeaders.traceContext.traceId=traceId"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.tracing.additionalTraceHeaders.traceContext.traceParent=traceParent"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.tracing.additionalTraceHeaders.traceContext.traceState=traceState"
  - it: should be possible to configure Traefik Hub microcks provider
    set:
      hub:
        providers:
          microcks:
            enabled: true
            endpoint: "http://microcks.svc"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.microcks.endpoint=http://microcks.svc"
  - it: should be possible to configure Traefik Hub consulCatalogEnterprise provider
    set:
      hub:
        providers:
          consulCatalogEnterprise:
            enabled: true
            cache: true
            connectAware: true
            connectByDefault: true
            constraints: "constraints"
            defaultRule: "defaultRule"
            endpoint:
              address: "address"
              datacenter: "datacenter"
              endpointWaitTime: 1
              httpauth:
                password: "password"
                username: "username"
              scheme: "scheme"
              tls:
                ca: "ca"
                cert: "cert"
                insecureSkipVerify: true
                key: "key"
              token: "token"
            exposedByDefault: false
            namespaces: "namespaces"
            partition: "partition"
            prefix: "prefix"
            refreshInterval: 2
            requireConsistent: true
            serviceName: "serviceName"
            stale: true
            strictChecks: "strictChecks"
            watch: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.cache=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.connectAware=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.connectByDefault=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.constraints=constraints"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.defaultRule=defaultRule"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.address=address"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.datacenter=datacenter"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.endpointWaitTime=1"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.httpauth.password=password"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.httpauth.username=username"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.scheme=scheme"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.tls.ca=ca"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.tls.cert=cert"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.tls.insecureSkipVerify=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.tls.key=key"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.endpoint.token=token"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.namespaces=namespaces"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.partition=partition"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.prefix=prefix"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.refreshInterval=2"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.requireConsistent=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.serviceName=serviceName"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.stale=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.strictChecks=strictChecks"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.providers.consulCatalogEnterprise.watch=true"
  - it: should be possible to configure Traefik Hub plugin sources
    set:
      hub:
        token: "xxx"
        pluginRegistry:
          sources:
            plugin1:
              baseModuleName: "gitlab.company.com"
              gitlab:
                token: "glpat-xxxxxxxxxxxxxxxxxxxx"
                url: "https://gitlab.company.com"
            plugin2:
              baseModuleName: "github.enterprise.local"
              github:
                token: "ghp_xxxxxxxxxxxxxxxxxxxx"
                enterprise:
                  url: "https://github.enterprise.local"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.pluginregistry.sources.plugin1=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.pluginregistry.sources.plugin1.basemodulename=gitlab.company.com"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.pluginregistry.sources.plugin1.gitlab.url=https://gitlab.company.com"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.pluginregistry.sources.plugin1.gitlab.token=glpat-xxxxxxxxxxxxxxxxxxxx"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.pluginregistry.sources.plugin2=true"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.pluginregistry.sources.plugin2.basemodulename=github.enterprise.local"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.pluginregistry.sources.plugin2.github.enterprise.url=https://github.enterprise.local"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--hub.pluginregistry.sources.plugin2.github.token=ghp_xxxxxxxxxxxxxxxxxxxx"
